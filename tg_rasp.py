import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command
from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.context import FSMContext
from datetime import datetime, timedelta

API_TOKEN = "7548972982:AAH3NLQl1PxhYAcozBLlLfhY6BgY2QOUCMM"


schedule_data_all = [
    # Понедельник
    {"День": "Понедельник", "Время": "15:10", "Дисциплина": "Математический анализ", "Вид занятия": "пр",
     "Аудитория": "425", "Здание": "2", "Преподаватель": "БИЛЬЧЕНКО НАТАЛЬЯ ГРИГОРЬЕВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "неч"},

    {"День": "Понедельник", "Время": "16:50", "Дисциплина": "Физика", "Вид занятия": "л.р.",
     "Аудитория": "303", "Здание": "2", "Преподаватель": "ШАРИПОВА АЛИНА АЛЬБЕРТОВНА",
     "Кафедра": "Кафедра общей физики",
     "Даты": "08.09 22.09 06.10 20.10 03.11 17.11 01.12 15.12"},

    {"День": "Понедельник", "Время": "16:50", "Дисциплина": "Физика", "Вид занятия": "л.р.",
     "Аудитория": "303", "Здание": "2", "Преподаватель": "АНДРЕЕВА НАТАЛЬЯ ГЕННАДЬЕВНА",
     "Кафедра": "Кафедра общей физики",
     "Даты": "08.09 22.09 06.10 20.10 03.11 17.11 01.12 15.12"},

    # Вторник
    {"День": "Вторник", "Время": "08:00", "Дисциплина": "Физическая культура и спорт (элективная дисциплина)", "Вид занятия": "пр",
     "Аудитория": "ОЛИМП4", "Здание": "КСК", "Преподаватель": "ПРЕПОДАВАТЕЛЬ КАФЕДРЫ",
     "Кафедра": "Кафедра физической культуры и спорта", "Дни": "чет"},

    {"День": "Вторник", "Время": "11:20", "Дисциплина": "Основы программирования", "Вид занятия": "л.р.",
     "Аудитория": "219а", "Здание": "7", "Преподаватель": "МУСТАФАЕВ ТИМУР АЗИСОВИЧ",
     "Кафедра": "Кафедра динамики процессов и управления",
     "Даты": "02.09 09.09 16.09 23.09 30.09 07.10 14.10 21.10 28.10 11.11 18.11 25.11 02.12 09.12 16.12 30.12"},

    {"День": "Вторник", "Время": "11:20", "Дисциплина": "Информатика и основы информационных технологий", "Вид занятия": "л.р.",
     "Аудитория": "425", "Здание": "7", "Преподаватель": "ТУМБИНСКАЯ МАРИНА ВЛАДИМИРОВНА",
     "Кафедра": "Кафедра динамики процессов и управления",
     "Даты": "02.09 09.09 16.09 23.09 30.09 07.10 14.10 21.10 28.10 11.11 18.11 25.11 02.12 09.12 16.12 30.12"},

    {"День": "Вторник", "Время": "13:30", "Дисциплина": "Основы программирования", "Вид занятия": "л.р.",
     "Аудитория": "219а", "Здание": "7", "Преподаватель": "МУСТАФАЕВ ТИМУР АЗИСОВИЧ",
     "Кафедра": "Кафедра динамики процессов и управления",
     "Даты": "02.09 09.09 16.09 23.09 30.09 07.10 14.10 21.10 28.10 11.11 18.11 25.11 02.12 09.12 16.12 30.12"},

    {"День": "Вторник", "Время": "13:30", "Дисциплина": "Информатика и основы информационных технологий", "Вид занятия": "л.р.",
     "Аудитория": "425", "Здание": "7", "Преподаватель": "ТУМБИНСКАЯ МАРИНА ВЛАДИМИРОВНА",
     "Кафедра": "Кафедра динамики процессов и управления",
     "Даты": "02.09 09.09 16.09 23.09 30.09 07.10 14.10 21.10 28.10 11.11 18.11 25.11 02.12 09.12 16.12 30.12"},

    # Среда
    {"День": "Среда", "Время": "09:40", "Дисциплина": "Линейная алгебра и аналитическая геометрия", "Вид занятия": "пр",
     "Аудитория": "202", "Здание": "2", "Преподаватель": "БУЛАШОВ ДМИТРИЙ АНАТОЛЬЕВИЧ",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "неч"},

    {"День": "Среда", "Время": "11:20", "Дисциплина": "Философия", "Вид занятия": "пр",
     "Аудитория": "404", "Здание": "8", "Преподаватель": "ПРЕПОДАВАТЕЛЬ КАФЕДРЫ",
     "Кафедра": "Кафедра философии", "Дни": "чет"},

    {"День": "Среда", "Время": "11:20", "Дисциплина": "Основы российской государственности", "Вид занятия": "пр",
     "Аудитория": "401", "Здание": "2", "Преподаватель": "СИРАЗЕЕВА ТАЛИЯ ТИМЕРХАНОВНА",
     "Кафедра": "Кафедра философии", "Дни": "неч"},

    {"День": "Среда", "Время": "13:30", "Дисциплина": "Введение в профессиональную деятельность", "Вид занятия": "лек",
     "Аудитория": "334", "Здание": "8", "Преподаватель": "ПРЕПОДАВАТЕЛЬ КАФЕДРЫ",
     "Кафедра": "Кафедра динамики процессов и управления", "Дни": "чет"},

    {"День": "Среда", "Время": "13:30", "Дисциплина": "История России", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "ШАГБАНОВА ЮЛИЯ БОРИСОВНА",
     "Кафедра": "Кафедра социологии, политологии и менеджмента", "Дни": "неч"},

    {"День": "Среда", "Время": "15:10", "Дисциплина": "История России", "Вид занятия": "лек",
     "Аудитория": "355", "Здание": "8", "Преподаватель": "ШАГБАНОВА ЮЛИЯ БОРИСОВНА",
     "Кафедра": "Кафедра социологии, политологии и менеджмента", "Дни": "чет"},

    {"День": "Среда", "Время": "16:50", "Дисциплина": "Основы программирования", "Вид занятия": "лек",
     "Аудитория": "ДОТ3", "Здание": "ДОТ", "Преподаватель": "СИРАЗЕТДИНОВ РИФКАТ ТАЛГАТОВИЧ",
     "Кафедра": "Кафедра динамики процессов и управления", "Дни": "неч"},

    {"День": "Среда", "Время": "16:50", "Дисциплина": "История России", "Вид занятия": "лек",
     "Аудитория": "355", "Здание": "8", "Преподаватель": "ШАГБАНОВА ЮЛИЯ БОРИСОВНА",
     "Кафедра": "Кафедра социологии, политологии и менеджмента", "Дни": "чет"},

    # Четверг
    {"День": "Четверг", "Время": "08:00", "Дисциплина": "Философия", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "ПЕТРОВА НАТАЛЬЯ НИКОЛАЕВНА",
     "Кафедра": "Кафедра философии", "Дни": "неч"},

    {"День": "Четверг", "Время": "09:40", "Дисциплина": "Физика", "Вид занятия": "лек",
     "Аудитория": "актовый зал", "Здание": "2", "Преподаватель": "АСАДУЛЛИНА НАИЛЯ ЯСАВИЕВНА",
     "Кафедра": "Кафедра общей физики", "Дни": "неч"},

    {"День": "Четверг", "Время": "11:20", "Дисциплина": "Физика", "Вид занятия": "пр",
     "Аудитория": "304", "Здание": "2", "Преподаватель": "АСАДУЛЛИНА НАИЛЯ ЯСАВИЕВНА",
     "Кафедра": "Кафедра общей физики", "Дни": "чет"},

    {"День": "Четверг", "Время": "13:30", "Дисциплина": "Линейная алгебра и аналитическая геометрия", "Вид занятия": "пр",
     "Аудитория": "506", "Здание": "8", "Преподаватель": "БУЛАШОВ ДМИТРИЙ АНАТОЛЬЕВИЧ",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "чет"},

    {"День": "Четверг", "Время": "15:10", "Дисциплина": "Математический анализ", "Вид занятия": "пр",
     "Аудитория": "506", "Здание": "8", "Преподаватель": "БИЛЬЧЕНКО НАТАЛЬЯ ГРИГОРЬЕВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "чет"},

    # Пятница
    {"День": "Пятница", "Время": "08:00", "Дисциплина": "Физическая культура и спорт (элективная дисциплина)", "Вид занятия": "пр",
     "Аудитория": "ОЛИМП4", "Здание": "КСК", "Преподаватель": "ПРЕПОДАВАТЕЛЬ КАФЕДРЫ",
     "Кафедра": "Кафедра физической культуры и спорта"},

    {"День": "Пятница", "Время": "09:40", "Дисциплина": "Иностранный язык", "Вид занятия": "пр",
     "Аудитория": "506", "Здание": "2", "Преподаватель": "ТУКТАРОВА ГУЗЕЛЬ МАНСУРОВНА",
     "Кафедра": "Кафедра иностранных языков, русского и русского как иностранного"},

    {"День": "Пятница", "Время": "11:20", "Дисциплина": "Иностранный язык", "Вид занятия": "пр",
     "Аудитория": "506", "Здание": "2", "Преподаватель": "ТУКТАРОВА ГУЗЕЛЬ МАНСУРОВНА",
     "Кафедра": "Кафедра иностранных языков, русского и русского как иностранного", "Дни": "неч"},

    {"День": "Пятница", "Время": "11:20", "Дисциплина": "Математический анализ", "Вид занятия": "лек",
     "Аудитория": "актовый зал", "Здание": "2", "Преподаватель": "МИРОНОВА СВЕТЛАНА РАФАИЛОВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "чет"},

    {"День": "Пятница", "Время": "13:30", "Дисциплина": "Информатика и основы информационных технологий", "Вид занятия": "лек",
     "Аудитория": "419", "Здание": "7", "Преподаватель": "ТУМБИНСКАЯ МАРИНА ВЛАДИМИРОВНА",
     "Кафедра": "Кафедра динамики процессов и управления", "Дни": "неч"},

    # Суббота
    {"День": "Суббота", "Время": "08:00", "Дисциплина": "Философия", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "ПЕТРОВА НАТАЛЬЯ НИКОЛАЕВНА",
     "Кафедра": "Кафедра философии", "Дни": "чет"},

    {"День": "Суббота", "Время": "08:00", "Дисциплина": "Математический анализ", "Вид занятия": "лек",
     "Аудитория": "300", "Здание": "2", "Преподаватель": "МИРОНОВА СВЕТЛАНА РАФАИЛОВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "неч"},

    {"День": "Суббота", "Время": "09:40", "Дисциплина": "История России", "Вид занятия": "пр",
     "Аудитория": "530", "Здание": "8", "Преподаватель": "ЛЕОНОВ ИГОРЬ ВИКТОРОВИЧ",
     "Кафедра": "Кафедра социологии, политологии и менеджмента", "Дни": "неч"},

    {"День": "Суббота", "Время": "09:40", "Дисциплина": "Основы российской государственности", "Вид занятия": "пр",
     "Аудитория": "ЛЗ №3", "Здание": "2", "Преподаватель": "СИРАЗЕЕВА ТАЛИЯ ТИМЕРХАНОВНА",
     "Кафедра": "Кафедра философии", "Дни": "чет"},

    {"День": "Суббота", "Время": "11:20", "Дисциплина": "Математический анализ", "Вид занятия": "пр",
     "Аудитория": "338", "Здание": "8", "Преподаватель": "БИЛЬЧЕНКО НАТАЛЬЯ ГРИГОРЬЕВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "неч"},

    {"День": "Суббота", "Время": "11:20", "Дисциплина": "Основы российской государственности", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "СИРАЗЕЕВА ТАЛИЯ ТИМЕРХАНОВНА",
     "Кафедра": "Кафедра философии", "Дни": "чет"},

    {"День": "Суббота", "Время": "13:30", "Дисциплина": "Линейная алгебра и аналитическая геометрия", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "ШУРЫГИНА МАРИНА АЛЕКСАНДРОВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "чет"},

    {"День": "Суббота", "Время": "20:00", "Дисциплина": "Физическая культура и спорт", "Вид занятия": "лек",
     "Аудитория": "ДОТ2", "Здание": "ДОТ", "Преподаватель": "ГАЛИМОВА ЭЛЬГА ВИКТОРОВИЧ",
     "Кафедра": "Кафедра физической культуры и спорта", "Дни": "неч"},

]




groupset = "4123"

bot = Bot(token=API_TOKEN)
ADMIN_ID = 1893750503

groupset = "4123"
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# Белый список пользователей
whitelist = {ADMIN_ID}  # изначально только админ

# Клавиатура
kb_main = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="Прошлая неделя")],
        [KeyboardButton(text="Эта неделя")],
        [KeyboardButton(text="Следующая неделя")]
    ],
    resize_keyboard=True,
)

# --- Дата начала и конца расписания ---
START_DATE = datetime(2025, 9, 1)
END_DATE = datetime(2025, 12, 30)

# --- Функции работы с расписанием ---
def is_even_week(date: datetime) -> bool:
    delta_weeks = ((date - START_DATE).days) // 7
    return delta_weeks % 2 == 1

def filter_schedule(week: str):
    now = datetime.now()
    current_monday = now - timedelta(days=now.weekday())

    if week == "next":
        current_monday += timedelta(weeks=1)
    elif week == "prev":
        current_monday -= timedelta(weeks=1)

    if current_monday + timedelta(days=6) < START_DATE or current_monday > END_DATE:
        return None

    days_map = {"Понедельник": 0, "Вторник": 1, "Среда": 2, "Четверг": 3,
                "Пятница": 4, "Суббота": 5, "Воскресенье": 6}

    filtered = []
    for entry in schedule_data_all:
        day_num = days_map.get(entry.get("День"), -1)
        if day_num == -1:
            continue
        class_date = current_monday + timedelta(days=day_num)

        days_field = entry.get("Дни")
        if days_field == "неч" and is_even_week(class_date):
            continue
        elif days_field == "чет" and not is_even_week(class_date):
            continue

        if "Даты" in entry:
            dates_list = entry["Даты"].split()
            str_date = class_date.strftime("%d.%m")
            if str_date not in dates_list:
                continue

        filtered.append((class_date.strftime("%d.%m.%Y"), entry))

    return filtered

def format_schedule_list(entries):
    if not entries:
        return "Расписание недоступно."
    result = ""
    current_day = None
    for date_str, entry in sorted(entries, key=lambda x: (x[0], x[1]["Время"])):
        if date_str != current_day:
            result += f"\n📆 {date_str}  {entry['День'].upper()}\n"
            current_day = date_str
        time = entry['Время']
        subject = entry['Дисциплина']
        kind = entry.get('Вид занятия', '')
        aud = entry.get('Аудитория', '')
        building = entry.get('Здание', '')
        teacher = entry.get('Преподаватель', '')
        result += f"{time} | {subject} ({kind}) | аудитория {aud}, здание {building} | {teacher}\n"
    return result

# --- Проверка пользователя ---
def is_allowed(user_id: int) -> bool:
    return user_id in whitelist

# --- Команда /start ---
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    if not is_allowed(message.from_user.id):
        await message.answer("❌ У вас нет доступа к боту.")
        return

    await message.answer(
        f"Привет! Это бот расписания для группы {groupset}. Выберите неделю:",
        reply_markup=kb_main
    )

# --- Команда админа для добавления пользователя ---
@dp.message(Command("add"))
async def add_user(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        await message.answer("❌ Только админ может добавлять пользователей.")
        return

    args = message.text.split()
    if len(args) != 2:
        await message.answer("Использование: /add <user_id>")
        return

    try:
        new_user_id = int(args[1])
        whitelist.add(new_user_id)
        await message.answer(f"✅ Пользователь {new_user_id} добавлен в белый список.")
    except ValueError:
        await message.answer("❌ Некорректный ID пользователя.")

# --- Основной обработчик кнопок ---
@dp.message()
async def main_handler(message: types.Message):
    if not is_allowed(message.from_user.id):
        await message.answer("❌ У вас нет доступа к боту.")
        return

    text = message.text.strip()
    if text == "Эта неделя":
        sched = filter_schedule("this")
        if sched is None:
            await message.answer("📛 Расписание недоступно для этой недели.")
        else:
            await message.answer(format_schedule_list(sched))

    elif text == "Следующая неделя":
        sched = filter_schedule("next")
        if sched is None:
            await message.answer("📛 Расписание недоступно для следующей недели.")
        else:
            await message.answer(format_schedule_list(sched))

    elif text == "Прошлая неделя":
        sched = filter_schedule("prev")
        if sched is None:
            await message.answer("📛 Расписание недоступно для прошлой недели.")
        else:
            await message.answer(format_schedule_list(sched))

    else:
        await message.answer("Выберите неделю кнопками или введи команду /start")

# --- Запуск бота ---
async def main():
    await dp.start_polling(bot)

if __name__ == '__main__':
    asyncio.run(main())
