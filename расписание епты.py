from datetime import datetime, timedelta
import openpyxl
from openpyxl.styles import PatternFill, Font

day_colors = {
    "Понедельник": "C6E0B4",
    "Вторник": "BDD7EE",
    "Среда": "FFF2CC",
    "Четверг": "FCE4D6",
    "Пятница": "F4CCCC",
    "Суббота": "D9D9D9"
}

schedule_data_all = [
    # Понедельник
    {"День": "Понедельник", "Время": "15:10", "Дисциплина": "Математический анализ", "Вид занятия": "пр",
     "Аудитория": "425", "Здание": "2", "Преподаватель": "БИЛЬЧЕНКО НАТАЛЬЯ ГРИГОРЬЕВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "неч"},

    {"День": "Понедельник", "Время": "16:50", "Дисциплина": "Физика", "Вид занятия": "л.р.",
     "Аудитория": "303", "Здание": "2", "Преподаватель": "ШАРИПОВА АЛИНА АЛЬБЕРТОВНА",
     "Кафедра": "Кафедра общей физики",
     "Даты": "08.09 22.09 06.10 20.10 03.11 17.11 01.12 15.12"},

    {"День": "Понедельник", "Время": "16:50", "Дисциплина": "Физика", "Вид занятия": "л.р.",
     "Аудитория": "303", "Здание": "2", "Преподаватель": "АНДРЕЕВА НАТАЛЬЯ ГЕННАДЬЕВНА",
     "Кафедра": "Кафедра общей физики",
     "Даты": "08.09 22.09 06.10 20.10 03.11 17.11 01.12 15.12"},

    # Вторник
    {"День": "Вторник", "Время": "08:00", "Дисциплина": "Физическая культура и спорт (элективная дисциплина)", "Вид занятия": "пр",
     "Аудитория": "ОЛИМП4", "Здание": "КСК", "Преподаватель": "ПРЕПОДАВАТЕЛЬ КАФЕДРЫ",
     "Кафедра": "Кафедра физической культуры и спорта", "Дни": "чет"},

    {"День": "Вторник", "Время": "11:20", "Дисциплина": "Основы программирования", "Вид занятия": "л.р.",
     "Аудитория": "219а", "Здание": "7", "Преподаватель": "МУСТАФАЕВ ТИМУР АЗИСОВИЧ",
     "Кафедра": "Кафедра динамики процессов и управления",
     "Даты": "02.09 09.09 16.09 23.09 30.09 07.10 14.10 21.10 28.10 11.11 18.11 25.11 02.12 09.12 16.12 30.12"},

    {"День": "Вторник", "Время": "11:20", "Дисциплина": "Информатика и основы информационных технологий", "Вид занятия": "л.р.",
     "Аудитория": "425", "Здание": "7", "Преподаватель": "ТУМБИНСКАЯ МАРИНА ВЛАДИМИРОВНА",
     "Кафедра": "Кафедра динамики процессов и управления",
     "Даты": "02.09 09.09 16.09 23.09 30.09 07.10 14.10 21.10 28.10 11.11 18.11 25.11 02.12 09.12 16.12 30.12"},

    {"День": "Вторник", "Время": "13:30", "Дисциплина": "Основы программирования", "Вид занятия": "л.р.",
     "Аудитория": "219а", "Здание": "7", "Преподаватель": "МУСТАФАЕВ ТИМУР АЗИСОВИЧ",
     "Кафедра": "Кафедра динамики процессов и управления",
     "Даты": "02.09 09.09 16.09 23.09 30.09 07.10 14.10 21.10 28.10 11.11 18.11 25.11 02.12 09.12 16.12 30.12"},

    {"День": "Вторник", "Время": "13:30", "Дисциплина": "Информатика и основы информационных технологий", "Вид занятия": "л.р.",
     "Аудитория": "425", "Здание": "7", "Преподаватель": "ТУМБИНСКАЯ МАРИНА ВЛАДИМИРОВНА",
     "Кафедра": "Кафедра динамики процессов и управления",
     "Даты": "02.09 09.09 16.09 23.09 30.09 07.10 14.10 21.10 28.10 11.11 18.11 25.11 02.12 09.12 16.12 30.12"},

    # Среда
    {"День": "Среда", "Время": "09:40", "Дисциплина": "Линейная алгебра и аналитическая геометрия", "Вид занятия": "пр",
     "Аудитория": "202", "Здание": "2", "Преподаватель": "БУЛАШОВ ДМИТРИЙ АНАТОЛЬЕВИЧ",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "неч"},

    {"День": "Среда", "Время": "11:20", "Дисциплина": "Философия", "Вид занятия": "пр",
     "Аудитория": "404", "Здание": "8", "Преподаватель": "ПРЕПОДАВАТЕЛЬ КАФЕДРЫ",
     "Кафедра": "Кафедра философии", "Дни": "чет"},

    {"День": "Среда", "Время": "11:20", "Дисциплина": "Основы российской государственности", "Вид занятия": "пр",
     "Аудитория": "401", "Здание": "2", "Преподаватель": "СИРАЗЕЕВА ТАЛИЯ ТИМЕРХАНОВНА",
     "Кафедра": "Кафедра философии", "Дни": "неч"},

    {"День": "Среда", "Время": "13:30", "Дисциплина": "Введение в профессиональную деятельность", "Вид занятия": "лек",
     "Аудитория": "334", "Здание": "8", "Преподаватель": "ПРЕПОДАВАТЕЛЬ КАФЕДРЫ",
     "Кафедра": "Кафедра динамики процессов и управления", "Дни": "чет"},

    {"День": "Среда", "Время": "13:30", "Дисциплина": "История России", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "ШАГБАНОВА ЮЛИЯ БОРИСОВНА",
     "Кафедра": "Кафедра социологии, политологии и менеджмента", "Дни": "неч"},

    {"День": "Среда", "Время": "15:10", "Дисциплина": "История России", "Вид занятия": "лек",
     "Аудитория": "355", "Здание": "8", "Преподаватель": "ШАГБАНОВА ЮЛИЯ БОРИСОВНА",
     "Кафедра": "Кафедра социологии, политологии и менеджмента", "Дни": "чет"},

    {"День": "Среда", "Время": "16:50", "Дисциплина": "Основы программирования", "Вид занятия": "лек",
     "Аудитория": "ДОТ3", "Здание": "ДОТ", "Преподаватель": "СИРАЗЕТДИНОВ РИФКАТ ТАЛГАТОВИЧ",
     "Кафедра": "Кафедра динамики процессов и управления", "Дни": "неч"},

    {"День": "Среда", "Время": "16:50", "Дисциплина": "История России", "Вид занятия": "лек",
     "Аудитория": "355", "Здание": "8", "Преподаватель": "ШАГБАНОВА ЮЛИЯ БОРИСОВНА",
     "Кафедра": "Кафедра социологии, политологии и менеджмента", "Дни": "чет"},

    # Четверг
    {"День": "Четверг", "Время": "08:00", "Дисциплина": "Философия", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "ПЕТРОВА НАТАЛЬЯ НИКОЛАЕВНА",
     "Кафедра": "Кафедра философии", "Дни": "неч"},

    {"День": "Четверг", "Время": "09:40", "Дисциплина": "Физика", "Вид занятия": "лек",
     "Аудитория": "актовый зал", "Здание": "2", "Преподаватель": "АСАДУЛЛИНА НАИЛЯ ЯСАВИЕВНА",
     "Кафедра": "Кафедра общей физики", "Дни": "неч"},

    {"День": "Четверг", "Время": "11:20", "Дисциплина": "Физика", "Вид занятия": "пр",
     "Аудитория": "304", "Здание": "2", "Преподаватель": "АСАДУЛЛИНА НАИЛЯ ЯСАВИЕВНА",
     "Кафедра": "Кафедра общей физики", "Дни": "чет"},

    {"День": "Четверг", "Время": "13:30", "Дисциплина": "Линейная алгебра и аналитическая геометрия", "Вид занятия": "пр",
     "Аудитория": "506", "Здание": "8", "Преподаватель": "БУЛАШОВ ДМИТРИЙ АНАТОЛЬЕВИЧ",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "чет"},

    {"День": "Четверг", "Время": "15:10", "Дисциплина": "Математический анализ", "Вид занятия": "пр",
     "Аудитория": "506", "Здание": "8", "Преподаватель": "БИЛЬЧЕНКО НАТАЛЬЯ ГРИГОРЬЕВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "чет"},

    # Пятница
    {"День": "Пятница", "Время": "08:00", "Дисциплина": "Физическая культура и спорт (элективная дисциплина)", "Вид занятия": "пр",
     "Аудитория": "ОЛИМП4", "Здание": "КСК", "Преподаватель": "ПРЕПОДАВАТЕЛЬ КАФЕДРЫ",
     "Кафедра": "Кафедра физической культуры и спорта"},

    {"День": "Пятница", "Время": "09:40", "Дисциплина": "Иностранный язык", "Вид занятия": "пр",
     "Аудитория": "506", "Здание": "2", "Преподаватель": "ТУКТАРОВА ГУЗЕЛЬ МАНСУРОВНА",
     "Кафедра": "Кафедра иностранных языков, русского и русского как иностранного"},

    {"День": "Пятница", "Время": "11:20", "Дисциплина": "Иностранный язык", "Вид занятия": "пр",
     "Аудитория": "506", "Здание": "2", "Преподаватель": "ТУКТАРОВА ГУЗЕЛЬ МАНСУРОВНА",
     "Кафедра": "Кафедра иностранных языков, русского и русского как иностранного", "Дни": "неч"},

    {"День": "Пятница", "Время": "11:20", "Дисциплина": "Математический анализ", "Вид занятия": "лек",
     "Аудитория": "актовый зал", "Здание": "2", "Преподаватель": "МИРОНОВА СВЕТЛАНА РАФАИЛОВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "чет"},

    {"День": "Пятница", "Время": "13:30", "Дисциплина": "Информатика и основы информационных технологий", "Вид занятия": "лек",
     "Аудитория": "419", "Здание": "7", "Преподаватель": "ТУМБИНСКАЯ МАРИНА ВЛАДИМИРОВНА",
     "Кафедра": "Кафедра динамики процессов и управления", "Дни": "неч"},

    # Суббота
    {"День": "Суббота", "Время": "08:00", "Дисциплина": "Философия", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "ПЕТРОВА НАТАЛЬЯ НИКОЛАЕВНА",
     "Кафедра": "Кафедра философии", "Дни": "чет"},

    {"День": "Суббота", "Время": "08:00", "Дисциплина": "Математический анализ", "Вид занятия": "лек",
     "Аудитория": "300", "Здание": "2", "Преподаватель": "МИРОНОВА СВЕТЛАНА РАФАИЛОВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "неч"},

    {"День": "Суббота", "Время": "09:40", "Дисциплина": "История России", "Вид занятия": "пр",
     "Аудитория": "530", "Здание": "8", "Преподаватель": "ЛЕОНОВ ИГОРЬ ВИКТОРОВИЧ",
     "Кафедра": "Кафедра социологии, политологии и менеджмента", "Дни": "неч"},

    {"День": "Суббота", "Время": "09:40", "Дисциплина": "Основы российской государственности", "Вид занятия": "пр",
     "Аудитория": "ЛЗ №3", "Здание": "2", "Преподаватель": "СИРАЗЕЕВА ТАЛИЯ ТИМЕРХАНОВНА",
     "Кафедра": "Кафедра философии", "Дни": "чет"},

    {"День": "Суббота", "Время": "11:20", "Дисциплина": "Математический анализ", "Вид занятия": "пр",
     "Аудитория": "338", "Здание": "8", "Преподаватель": "БИЛЬЧЕНКО НАТАЛЬЯ ГРИГОРЬЕВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "неч"},

    {"День": "Суббота", "Время": "11:20", "Дисциплина": "Основы российской государственности", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "СИРАЗЕЕВА ТАЛИЯ ТИМЕРХАНОВНА",
     "Кафедра": "Кафедра философии", "Дни": "чет"},

    {"День": "Суббота", "Время": "13:30", "Дисциплина": "Линейная алгебра и аналитическая геометрия", "Вид занятия": "лек",
     "Аудитория": "333", "Здание": "8", "Преподаватель": "ШУРЫГИНА МАРИНА АЛЕКСАНДРОВНА",
     "Кафедра": "Кафедра теоретической и прикладной механики и математики", "Дни": "чет"},

    {"День": "Суббота", "Время": "20:00", "Дисциплина": "Физическая культура и спорт", "Вид занятия": "лек",
     "Аудитория": "ДОТ2", "Здание": "ДОТ", "Преподаватель": "ГАЛИМОВА ЭЛЬГА ВИКТОРОВИЧ",
     "Кафедра": "Кафедра физической культуры и спорта", "Дни": "неч"},

]


start_date = datetime(2025, 9, 1)
end_date = datetime(2025, 12, 30)

days_order = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"]

def get_week_number(current_date, start_date):
    return ((current_date - start_date).days // 7) + 1

def get_week_dates(week_num, start_date):
    week_start = start_date + timedelta(days=(week_num - 1) * 7)
    week_end = week_start + timedelta(days=5)  # Пн-Сб
    return week_start, week_end

wb = openpyxl.Workbook()
wb.remove(wb.active)

schedule_by_week = {}

current_date = start_date
while current_date <= end_date:
    if current_date.weekday() == 6:  # пропустить воскресенье
        current_date += timedelta(days=1)
        continue

    day_ru = days_order[current_date.weekday()]
    week_num = get_week_number(current_date, start_date)

    if week_num not in schedule_by_week:
        schedule_by_week[week_num] = {d: [] for d in days_order}

    for lesson in schedule_data_all:
        if lesson["День"] != day_ru:
            continue

        lesson_dates_for_day = []

        if lesson.get("Даты"):
            for d_str in lesson["Даты"].split():
                d = datetime.strptime(d_str + f".{current_date.year}", "%d.%m.%Y")
                if start_date <= d <= end_date and d.date() == current_date.date():
                    lesson_dates_for_day.append(d)
        elif lesson.get("Дни") == "чет":
            if current_date.day % 2 == 0:
                lesson_dates_for_day.append(current_date)
        elif lesson.get("Дни") == "неч":
            if current_date.day % 2 != 0:
                lesson_dates_for_day.append(current_date)
        else:
            # Если ни "Даты", ни "Дни", предполагаем занятия каждый появляющийся день
            lesson_dates_for_day.append(current_date)

        for d in lesson_dates_for_day:
            schedule_by_week[week_num][day_ru].append({
                "Время": lesson["Время"],
                "Дата занятия": d.strftime("%d.%m.%Y"),
                "Дисциплина": lesson["Дисциплина"],
                "Вид занятия": lesson.get("Вид занятия", ""),
                "Аудитория": lesson["Аудитория"],
                "Здание": lesson["Здание"],
                "Преподаватель": lesson.get("Преподаватель", ""),
                "Кафедра": lesson.get("Кафедра", "")
            })

    current_date += timedelta(days=1)

header = ["День недели", "Время", "Дата занятия", "Дисциплина", "Вид занятия", "Аудитория", "Здание",
          "Преподаватель", "Кафедра", "Неделя", "Даты недели"]

for week_num in sorted(schedule_by_week.keys()):
    week_start, week_end = get_week_dates(week_num, start_date)
    ws = wb.create_sheet(f"Неделя {week_num} ({week_start.strftime('%d.%m')} - {week_end.strftime('%d.%m')})")

    ws.append([f"Учебная неделя {week_num}: с {week_start.strftime('%d.%m.%Y')} по {week_end.strftime('%d.%m.%Y')}"])
    ws.append([])
    ws.append(header)
    for col in range(1, len(header) + 1):
        ws.cell(row=3, column=col).font = Font(bold=True)

    for day in days_order:
        lessons = schedule_by_week[week_num].get(day, [])
        if not lessons:
            continue

        ws.append([day])
        row_idx = ws.max_row
        for col_i in range(1, len(header) + 1):
            cell = ws.cell(row=row_idx, column=col_i)
            cell.font = Font(bold=True)
            cell.fill = PatternFill(start_color=day_colors[day], end_color=day_colors[day], fill_type="solid")

        for les in lessons:
            ws.append([
                day,
                les["Время"],
                les["Дата занятия"],
                les["Дисциплина"],
                les["Вид занятия"],
                les["Аудитория"],
                les["Здание"],
                les["Преподаватель"],
                les["Кафедра"],
                f"Неделя {week_num}",
                f"{week_start.strftime('%d.%m.%Y')} - {week_end.strftime('%d.%m.%Y')}"
            ])
            row_idx = ws.max_row
            for col_i in range(1, len(header) + 1):
                ws.cell(row=row_idx, column=col_i).fill = PatternFill(start_color=day_colors[day], end_color=day_colors[day], fill_type="solid")

        ws.append([])  # разделитель дней

wb.save("расписание_по_неделям_с_датами.xlsx")
print("Файл создан: расписание_по_неделям_с_датами.xlsx")
